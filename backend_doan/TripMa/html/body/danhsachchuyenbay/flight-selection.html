<link rel="stylesheet" href="../../../css/body/danhsachchuyenbay/flight-selection.css">


<!-- Ch·ªçn chuy·∫øn bay -->
<section class="flight-selection">
    <h3 class="selection-title">L·ª±a ch·ªçn chuy·∫øn bay kh·ª© h·ªìi</h3>
    <div class="flight-list"></div>
</section>

<script>
function formatFlightTime(timeString) {
    if (!timeString) return '00:00';
    if (timeString.includes(' ')) {
        return timeString.split(' ')[1].slice(0, 5);
    }
    return timeString;
}

function parseDateTimeString(str) {
    if (!str) return null;
    if (str.includes(' ')) {
        const [datePart, timePart] = str.split(' ');
        const [year, month, day] = datePart.split('-').map(Number);
        const [hour, minute] = timePart.split(':').map(Number);
        return new Date(year, month - 1, day, hour, minute);
    }
    return new Date(str);
}

document.addEventListener('DOMContentLoaded', function() {
    const flights = JSON.parse(sessionStorage.getItem('searchFlightResults') || '[]');
    const flightList = document.querySelector('.flight-list');
    if (!flightList) return;

    flightList.innerHTML = '';

    if (!flights.length) {
        flightList.innerHTML = '<div class="no-flights">Kh√¥ng c√≥ chuy·∫øn bay n√†o ph√π h·ª£p.</div>';
        return;
    }

    flights.forEach(flight => {
        // T√≠nh th·ªùi gian bay b·∫±ng ph√∫t
        const departureTimeObj = parseDateTimeString(flight.ThoiGianKhoiHanh);
        const arrivalTimeObj = parseDateTimeString(flight.ThoiGianHaCanh);
        const durationMinutes = Math.round((arrivalTimeObj - departureTimeObj)/60000);
        const hours = Math.floor(durationMinutes / 60);
        const minutes = durationMinutes % 60;
        const durationFormatted = `${hours}h ${minutes}ph√∫t`;
        
        // L·∫•y gi√° v√©
        const basePrice = Number(flight.GiaCoSo);
        
        // S·ªë gh·∫ø c√≤n l·∫°i
        const standardSeats = Math.floor(Math.random() * 10) + 1;

        // M√£ s√¢n bay (hardcode ho·∫∑c map t·ª´ ID n·∫øu c√≥)
        const fromAirportCode = flight.ID_SanBayDi == 1 ? "SGN" : 
                               flight.ID_SanBayDi == 2 ? "HAN" :
                               flight.ID_SanBayDi == 3 ? "DAD" : "SGN";
                                
        const toAirportCode = flight.ID_SanBayDen == 1 ? "SGN" :
                             flight.ID_SanBayDen == 2 ? "HAN" :
                             flight.ID_SanBayDen == 3 ? "DAD" : "HAN";

        // HTML cho card
        const flightCard = document.createElement('div');
        flightCard.className = 'flight-card';
        flightCard.innerHTML = `
            <img src="../../../assets/logo/logo.png" alt="Tripma Logo" class="tripma-logo">
            <div class="flight-info">
                <div class="flight-main-info">
                    <div class="flight-route">
                        <div class="flight-time-departure">
                            <span class="time" style="font-size:2.2rem;font-weight:bold;color:#4b47d4;">
                                ${formatFlightTime(flight.ThoiGianKhoiHanh)}
                            </span>
                            <span class="airport" style="font-size:1.2rem;font-weight:bold;color:#4b47d4;">${fromAirportCode}</span>
                            <span class="terminal">Nh√† ga ${Math.floor(Math.random() * 3) + 1}</span>
                        </div>
                        
                        <div class="flight-direction">
                            <span class="flight-type" style="color:#ff6600;font-weight:bold;">Bay th·∫≥ng</span>
                            <div class="flight-line"></div>
                        </div>
                        
                        <div class="flight-time-arrival">
                            <span class="time" style="font-size:2.2rem;font-weight:bold;color:#4b47d4;">
                                ${formatFlightTime(flight.ThoiGianHaCanh)}
                            </span>
                            <span class="airport" style="font-size:1.2rem;font-weight:bold;color:#4b47d4;">${toAirportCode}</span>
                            <span class="terminal">Nh√† ga ${Math.floor(Math.random() * 3) + 1}</span>
                        </div>
                    </div>
                    
                    <div class="flight-details">
                        <div class="flight-duration">
                            <span class="duration-icon">üïí</span>
                            <span class="duration-text">Th·ªùi gian bay ${durationFormatted}</span>
                        </div>
                        <div class="flight-airline">
                            <span class="flight-number">VN ${flight.ID_ChuyenBay}</span>
                            <span class="airline-name">Khai th√°c b·ªüi Vietnam Airlines</span>
                        </div>
                        <a href="#" class="flight-details-link" style="color:#5a56f3;font-weight:bold;">Chi ti·∫øt h√†nh tr√¨nh ‚Üí</a>
                    </div>
                </div>
            </div>
            <div class="flight-fares">
                <div class="fare-option economy" data-flight="${flight.ID_ChuyenBay}" data-class="economy">
                    <div class="fare-header">
                        <span class="fare-name" style="font-weight:bold;">PH·ªî TH√îNG</span>
                        <span class="seats-left">${standardSeats} gh·∫ø c√≤n l·∫°i</span>
                    </div>
                    <div class="fare-price">
                        <span class="fare-from">t·ª´</span>
                        <span class="price-value" style="font-size:2rem;font-weight:bold;color:#ff6600;">${basePrice.toLocaleString()}</span>
                        <span class="price-currency">VND</span>
                    </div>
                    <div class="fare-select">
                        <button class="select-button" style="background:linear-gradient(90deg,#ff6600,#ffb347);color:white;font-weight:bold;border:none;border-radius:20px;padding:10px 30px;font-size:1.1rem;cursor:pointer;">Ch·ªçn</button>
                    </div>
                </div>
            </div>
        `;

        // Th√™m event listener cho c√°c n√∫t "Ch·ªçn"
        const selectButtons = flightCard.querySelectorAll('.select-button');
        selectButtons.forEach(button => {
            button.addEventListener('click', function() {
                const fareOption = button.closest('.fare-option');
                const flightId = fareOption.dataset.flight;
                const fareClass = fareOption.dataset.class;
                const farePrice = fareOption.querySelector('.price-value').textContent.replace(/\D/g, '');
                
                // L∆∞u th√¥ng tin chuy·∫øn bay ƒë∆∞·ª£c ch·ªçn k√®m th√™m th√¥ng tin v·ªÅ h·∫°ng v√©
                const selectedInfo = JSON.parse(JSON.stringify(flight));
                selectedInfo.selectedClass = fareClass;
                selectedInfo.selectedPrice = farePrice;
                
                sessionStorage.setItem('selectedFlightInfo', JSON.stringify(selectedInfo));
                
                // X·ª≠ l√Ω hi·ªÉn th·ªã placeholder ho·∫∑c chuy·ªÉn trang
                const passengerInfoPlaceholder = document.getElementById('passenger-info-placeholder');
                const flightResultsPlaceholder = document.getElementById('flight-results-placeholder');
                
                if (passengerInfoPlaceholder && flightResultsPlaceholder) {
                    flightResultsPlaceholder.style.display = 'none';
                    passengerInfoPlaceholder.style.display = 'block';
                    
                    fetch('../../../html/body/chonghechuyenbay/choose-flight-seat.html')
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Network response was not ok');
                            }
                            return response.text();
                        })
                        .then(html => {
                            passengerInfoPlaceholder.innerHTML = html;
                            // N·∫øu c√≥ CSS ri√™ng cho choose-flight-seat th√¨ load, n·∫øu kh√¥ng th√¨ b·ªè qua
                            if (!document.querySelector('link[href*="choose-flight-seat.css"]')) {
                                const link = document.createElement('link');
                                link.rel = 'stylesheet';
                                link.href = '../../../css/body/chonghechuyenbay/choose-flight-seat.css';
                                document.head.appendChild(link);
                            }
                            // N·∫øu c√≥ h√†m kh·ªüi t·∫°o ri√™ng th√¨ g·ªçi ·ªü ƒë√¢y (n·∫øu c√≥)
                            if (typeof initChooseFlightSeat == 'function') {
                                initChooseFlightSeat();
                            }
                            const backButton = document.createElement('button');
                            backButton.textContent = 'Quay l·∫°i danh s√°ch chuy·∫øn bay';
                            backButton.className = 'back-button';
                            backButton.onclick = function() {
                                passengerInfoPlaceholder.style.display = 'none';
                                flightResultsPlaceholder.style.display = 'block';
                            };
                            passengerInfoPlaceholder.insertBefore(backButton, passengerInfoPlaceholder.firstChild);
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            passengerInfoPlaceholder.innerHTML = `
                                <div style="text-align: center; padding: 20px;">
                                    <h3>C√≥ l·ªói x·∫£y ra khi t·∫£i form</h3>
                                    <p>Vui l√≤ng th·ª≠ l·∫°i ho·∫∑c t·∫£i l·∫°i trang</p>
                                    <button onclick="window.location.reload()">T·∫£i l·∫°i trang</button>
                                </div>`;
                        });
                } else {
                    // N·∫øu kh√¥ng c√≥ placeholder, chuy·ªÉn h∆∞·ªõng ƒë·∫øn trang th√¥ng tin h√†nh kh√°ch
                    window.location.href = '../../../html/body/chonghechuyenbay/choose-flight-seat.html';
                }
            });
        });

        // Th√™m card v√†o danh s√°ch
        flightList.appendChild(flightCard);
    });
});
</script>